# SPDX-License-Identifier: AGPL-3.0-or-later
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'claude/*' ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  security-events: write

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      RAILS_ENV: test
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/candy_crash_test

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Ruby
        uses: ruby/setup-ruby@a6e6f86333f0a2523ece813039b8b4be04560854 # v1.190.0
        with:
          ruby-version: 3.3.6
          bundler-cache: true

      - name: Set up Deno
        uses: denoland/setup-deno@e95f66e8f7c1f3d7fc8ff29cb879b5a1e9c1ce36 # v2.0.2
        with:
          deno-version: v1.x

      - name: Install dependencies
        run: |
          bundle install

      - name: Setup database
        run: |
          bin/rails db:create
          bin/rails db:schema:load

      - name: Run tests with coverage
        run: COVERAGE=true bundle exec rspec --format documentation
        env:
          COVERAGE: true
      - name: Upload coverage
        uses: codecov/codecov-action@eaaf4bedf32dbdc6b720b63067d99c4d77d6047d # v5.0.2
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Ruby
        uses: ruby/setup-ruby@a6e6f86333f0a2523ece813039b8b4be04560854 # v1.190.0
        with:
          ruby-version: 3.3.6
          bundler-cache: true

      - name: Run RuboCop
        run: bundle exec rubocop --parallel

      - name: Run Brakeman (Security)
        run: |
          gem install brakeman
          brakeman --run-all-checks --exit-on-warn

      - name: Run Bundler Audit
        run: |
          gem install bundler-audit
          bundle audit check --update

  build:
    name: Build Assets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Ruby
        uses: ruby/setup-ruby@a6e6f86333f0a2523ece813039b8b4be04560854 # v1.190.0
        with:
          ruby-version: 3.3.6
          bundler-cache: true

      - name: Set up Deno
        uses: denoland/setup-deno@e95f66e8f7c1f3d7fc8ff29cb879b5a1e9c1ce36 # v2.0.2
        with:
          deno-version: v1.x

      - name: Install dependencies
        run: |
          bundle install

      - name: Precompile assets
        run: bin/rails assets:precompile
        env:
          RAILS_ENV: production
          SECRET_KEY_BASE: dummy_secret_for_asset_compilation

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Dependency Review
        uses: actions/dependency-review-action@5a2ce3f5b92ee19cbb1541a4984c76d921601d7c # v4.3.4

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Initialize CodeQL
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v3.28.1
        with:
          languages: ruby, javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v3.28.1

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v3.28.1

  rsr-validation:
    name: RSR Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Ruby
        uses: ruby/setup-ruby@a6e6f86333f0a2523ece813039b8b4be04560854 # v1.190.0
        with:
          ruby-version: 3.3.6
          bundler-cache: true

      - name: Check documentation files
        run: |
          echo "üìö Validating RSR documentation requirements..."
          required_docs=(
            "LICENSE.txt"
            "SECURITY.md"
            "CONTRIBUTING.adoc"
            "CODE_OF_CONDUCT.adoc"
            "MAINTAINERS.adoc"
            "CHANGELOG.adoc"
            "FUNDING.yml"
            "GOVERNANCE.adoc"
            "REVERSIBILITY.adoc"
            ".gitignore"
            ".gitattributes"
          )
          missing=0
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "‚ùå Missing: $doc"
              missing=1
            else
              echo "‚úÖ $doc"
            fi
          done
          if [ $missing -eq 1 ]; then
            exit 1
          fi

      - name: Check .well-known files
        run: |
          echo "üìÅ Validating .well-known directory..."
          wellknown_files=(
            "public/.well-known/security.txt"
            "public/.well-known/ai.txt"
            "public/.well-known/humans.txt"
            "public/.well-known/consent-required.txt"
            "public/.well-known/provenance.json"
          )
          missing=0
          for file in "${wellknown_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing: $file"
              missing=1
            else
              echo "‚úÖ $file"
            fi
          done
          if [ $missing -eq 1 ]; then
            exit 1
          fi

      - name: Validate SPDX headers
        run: |
          echo "üìù Checking SPDX headers in Ruby files..."
          missing=0
          for file in $(find app lib config -name "*.rb" 2>/dev/null | head -50); do
            if ! grep -q "SPDX-License-Identifier" "$file"; then
              echo "‚ùå Missing SPDX header: $file"
              missing=1
            fi
          done
          if [ $missing -eq 0 ]; then
            echo "‚úÖ All checked files have SPDX headers"
          else
            echo "‚ö†Ô∏è  Some files missing SPDX headers"
            exit 1
          fi

  container-build:
    name: Build Container Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Podman
        run: |
          # Ubuntu 22.04+ has Podman in default repos
          sudo apt-get update
          sudo apt-get -y install podman

      - name: Build Podman image
        run: |
          podman build -t candy-crash:test -f Containerfile .

      - name: Test container
        run: |
          podman run --rm candy-crash:test bundle --version
          echo "‚úÖ Container builds and runs successfully"

      - name: Inspect image
        run: |
          podman inspect candy-crash:test | jq '.[0].Config.User'
          echo "‚úÖ Container inspection complete"
